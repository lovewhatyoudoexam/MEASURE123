<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èªæ³•ç©æœ¨å·¥å»  - æ™®ç‰¹èåˆæ¢ç´¢å°ç‰¹å¸«å°ˆç”¨</title>
    <!-- ä½¿ç”¨æ›´ç©©å®šçš„ CDN ä¾†æº -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
            user-select: none;
            touch-action: manipulation; /* å„ªåŒ–è§¸æ§é«”é©— */
        }
        .block-shadow {
            box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }
        .block-shadow:active {
            box-shadow: 1px 1px 0px rgba(0,0,0,0.2);
            transform: translate(3px, 3px);
        }
        .selected-glow {
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8), 4px 4px 0px rgba(0,0,0,0.2);
            transform: scale(1.05);
            border: 2px solid #FFD700;
            z-index: 10;
        }
        @keyframes bounce-short {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce-short {
            animation: bounce-short 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // é¡Œç›®è³‡æ–™åº«
        const QUESTIONS = [
            { id: 1, noun: "æ²™ç™¼", measure: "å¼µ", quantity: "ä¸€", imageHint: "ğŸ›‹ï¸" },
            { id: 2, noun: "ç•«", measure: "å¹…", quantity: "ä¸€", imageHint: "ğŸ–¼ï¸" },
            { id: 3, noun: "æ¡Œå­", measure: "å¼µ", quantity: "ä¸€", imageHint: "ğŸªµ" },
            { id: 4, noun: "èŠ±", measure: "æŸ", quantity: "ä¸€", imageHint: "ğŸ’" },
            { id: 5, noun: "åœå·¾", measure: "æ¢", quantity: "ä¸€", imageHint: "ğŸ§£" },
            { id: 6, noun: "çœ¼é¡", measure: "å‰¯", quantity: "ä¸€", imageHint: "ğŸ‘“" },
            { id: 7, noun: "æ‰‹å¥—", measure: "å‰¯", quantity: "ä¸€", imageHint: "ğŸ§¤" },
            { id: 8, noun: "è¡£æœ", measure: "ä»¶", quantity: "ä¸€", imageHint: "ğŸ‘•" },
        ];

        // æ··æ·†é¸é …
        const DISTRACTORS = {
            measures: ["å€‹", "éš»", "æœ¬", "é¡†"],
            quantities: ["å…©", "ä¸‰"]
        };

        const App = () => {
            const [currentQIndex, setCurrentQIndex] = useState(0);
            const [slots, setSlots] = useState({ quantity: null, measure: null, noun: null });
            const [inventory, setInventory] = useState([]);
            const [feedback, setFeedback] = useState({ type: "", msg: "" });
            const [score, setScore] = useState(0);
            const [isCompleted, setIsCompleted] = useState(false);
            
            // æ–°å¢ï¼šç›®å‰é¸ä¸­çš„ç©æœ¨ (ç‚ºäº†æ”¯æ´é»æ“Šæ¨¡å¼)
            const [selectedItem, setSelectedItem] = useState(null);

            const currentQuestion = QUESTIONS[currentQIndex];

            // åˆå§‹åŒ–
            useEffect(() => {
                resetLevel();
            }, [currentQIndex]);

            const resetLevel = () => {
                setSlots({ quantity: null, measure: null, noun: null });
                setFeedback({ type: "", msg: "" });
                setSelectedItem(null);
                
                const q = QUESTIONS[currentQIndex];
                
                // 1. å¿…å‚™ç©æœ¨
                let items = [
                    { id: `q-${q.quantity}`, text: q.quantity, type: "quantity" },
                    { id: `m-${q.measure}`, text: q.measure, type: "measure" },
                    { id: `n-${q.noun}`, text: q.noun, type: "noun" }
                ];

                // 2. å¹²æ“¾é …
                const wrongMeasure = DISTRACTORS.measures.find(m => m !== q.measure) || "å€‹";
                items.push({ id: `m-wrong`, text: wrongMeasure, type: "measure" });
                
                if (Math.random() > 0.5) {
                    items.push({ id: `q-wrong`, text: "å…©", type: "quantity" });
                }

                // æ´—ç‰Œ
                items = items.sort(() => Math.random() - 0.5);
                setInventory(items);
            };

            // --- äº’å‹•é‚è¼¯ (æ”¯æ´ é»æ“Š å’Œ æ‹–æ›³) ---

            // 1. é»æ“Šåº«å­˜ä¸­çš„ç©æœ¨
            const handleInventoryClick = (item) => {
                // å¦‚æœå·²ç¶“é¸ä¸­åŒä¸€å€‹ï¼Œå–æ¶ˆé¸å–
                if (selectedItem && selectedItem.id === item.id) {
                    setSelectedItem(null);
                } else {
                    setSelectedItem(item);
                    setFeedback({ type: "info", msg: `é¸ä¸­äº†ã€Œ${item.text}ã€ï¼Œè«‹é»æ“Šä¸Šæ–¹çš„æ ¼å­æ”¾å…¥` });
                }
            };

            // 2. é»æ“Šæ ¼å­ (å˜—è©¦æ”¾å…¥)
            const handleSlotClick = (targetSlotType) => {
                // å¦‚æœæœ‰é»é¸ç©æœ¨ï¼Œå˜—è©¦æ”¾å…¥
                if (selectedItem) {
                    if (selectedItem.type === targetSlotType) {
                        placeItem(selectedItem, targetSlotType);
                    } else {
                        showError("å“å‘€ï¼é¡è‰²å½¢ç‹€ä¸å°å–”ï¼");
                    }
                } 
                // å¦‚æœæ²’é»é¸ç©æœ¨ï¼Œä½†æ ¼å­è£¡æœ‰æ±è¥¿ï¼Œå‰‡é€€å› (å–æ¶ˆæ”¾ç½®)
                else if (slots[targetSlotType]) {
                    returnBlock(targetSlotType);
                }
            };

            // æ ¸å¿ƒæ”¾ç½®é‚è¼¯
            const placeItem = (item, targetSlotType) => {
                setSlots(prev => ({ ...prev, [targetSlotType]: item }));
                setInventory(prev => prev.filter(i => i.id !== item.id));
                setSelectedItem(null); // æ¸…é™¤é¸å–
                setFeedback({ type: "", msg: "" });
            };

            // æ ¸å¿ƒé€€å›é‚è¼¯
            const returnBlock = (type) => {
                const item = slots[type];
                if (!item) return;
                setSlots(prev => ({ ...prev, [type]: null }));
                setInventory(prev => [...prev, item]);
            };

            // --- æ‹–æ›³é‚è¼¯ (ä¿ç•™çµ¦é›»è…¦ç‰ˆä½¿ç”¨) ---
            const handleDragStart = (e, item) => {
                setSelectedItem(item); // æ‹–æ›³æ™‚ä¹Ÿè¦–ç‚ºé¸å–
                e.dataTransfer.setData("item", JSON.stringify(item));
            };

            const handleDrop = (e, targetSlotType) => {
                e.preventDefault();
                const itemData = JSON.parse(e.dataTransfer.getData("item"));
                
                if (itemData.type !== targetSlotType) {
                    showError("å“å‘€ï¼é¡è‰²å½¢ç‹€ä¸å°å–”ï¼");
                    return;
                }
                placeItem(itemData, targetSlotType);
            };

            const handleDragOver = (e) => e.preventDefault();

            // --- è¼”åŠ©å‡½å¼ ---
            const showError = (msg) => {
                setFeedback({ type: "error", msg });
                setTimeout(() => setFeedback({ type: "", msg: "" }), 2000);
            };

            const checkAnswer = () => {
                const q = currentQuestion;
                if (!slots.quantity || !slots.measure || !slots.noun) {
                    setFeedback({ type: "warning", msg: "é‚„æ²’æ‹¼å®Œå–”ï¼åŠ æ²¹ï¼" });
                    return;
                }

                if (slots.noun.text === q.noun && 
                    slots.measure.text === q.measure && 
                    slots.quantity.text === q.quantity) {
                    
                    setFeedback({ type: "success", msg: "å¤ªæ£’äº†ï¼ç­”å°äº†ï¼ğŸ‰" });
                    
                    setTimeout(() => {
                        if (currentQIndex < QUESTIONS.length - 1) {
                            setScore(s => s + 10);
                            setCurrentQIndex(prev => prev + 1);
                        } else {
                            setScore(s => s + 10);
                            setIsCompleted(true);
                        }
                    }, 1500);
                } else {
                    showError("å†è©¦è©¦çœ‹ï¼Œé‡è©å¥½åƒç”¨éŒ¯å›‰ï¼Ÿ");
                }
            };

            const restartGame = () => {
                setCurrentQIndex(0);
                setScore(0);
                setIsCompleted(false);
                resetLevel();
            };

            // --- å…ƒä»¶æ¸²æŸ“ ---

            const Slot = ({ type, label, colorClass, value }) => (
                <div 
                    className={`
                        w-24 h-32 md:w-32 md:h-40 
                        border-4 border-dashed rounded-xl 
                        flex flex-col items-center justify-center 
                        transition-all duration-300 relative cursor-pointer
                        ${value ? 'border-solid border-gray-300 bg-white' : `border-gray-300 ${colorClass.bg}`}
                        ${selectedItem && selectedItem.type === type && !value ? 'animate-pulse border-yellow-400' : ''}
                    `}
                    onDragOver={handleDragOver}
                    onDrop={(e) => handleDrop(e, type)}
                    onClick={() => handleSlotClick(type)}
                >
                    <span className={`absolute -top-8 text-lg font-bold ${colorClass.text}`}>
                        {label}
                    </span>

                    {value ? (
                        <div className={`
                            w-20 h-20 md:w-28 md:h-28 
                            rounded-lg flex items-center justify-center 
                            text-3xl md:text-4xl font-bold text-white shadow-lg
                            ${colorClass.block}
                        `}>
                            {value.text}
                        </div>
                    ) : (
                        <div className="text-gray-400 text-sm text-center px-2">
                            {selectedItem && selectedItem.type === type ? "é»é€™è£¡æ”¾å…¥" : "è«‹æ”¾å…¥"}
                        </div>
                    )}
                </div>
            );

            const Block = ({ item }) => {
                let colorClass = "";
                if (item.type === "quantity") colorClass = "bg-pink-500 hover:bg-pink-400";
                else if (item.type === "measure") colorClass = "bg-blue-500 hover:bg-blue-400";
                else if (item.type === "noun") colorClass = "bg-green-500 hover:bg-green-400";

                const isSelected = selectedItem && selectedItem.id === item.id;

                return (
                    <div
                        draggable
                        onDragStart={(e) => handleDragStart(e, item)}
                        onClick={() => handleInventoryClick(item)}
                        className={`
                            w-20 h-20 md:w-24 md:h-24 m-2
                            rounded-xl block-shadow cursor-pointer
                            flex items-center justify-center
                            text-3xl font-bold text-white
                            transform transition-transform
                            ${colorClass}
                            ${isSelected ? 'selected-glow' : 'hover:scale-105'}
                        `}
                    >
                        {item.text}
                    </div>
                );
            };

            if (isCompleted) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-yellow-100 p-4">
                        <div className="text-8xl mb-6 animate-bounce-short">ğŸ†</div>
                        <h1 className="text-4xl font-bold text-yellow-800 mb-4">æ­å–œå®Œæˆï¼</h1>
                        <p className="text-xl text-yellow-700 mb-8">æ‰€æœ‰çš„é‡è©ç©æœ¨éƒ½æ‰¾å°äº†ï¼</p>
                        <div className="text-3xl font-bold text-pink-600 mb-8 bg-white px-8 py-4 rounded-xl shadow-sm">
                            å¾—åˆ†ï¼š{score}
                        </div>
                        <button 
                            onClick={restartGame}
                            className="px-8 py-4 bg-blue-500 text-white rounded-full text-xl font-bold shadow-lg hover:bg-blue-600 active:scale-95 transition"
                        >
                            å†ç©ä¸€æ¬¡
                        </button>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex flex-col max-w-4xl mx-auto p-4 pb-20">
                    {/* é ‚éƒ¨å°èˆª */}
                    <div className="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm mb-6">
                        <div className="flex items-center gap-2">
                            <span className="hidden md:inline bg-yellow-400 text-white px-3 py-1 rounded-full font-bold text-sm">L3 èª²æ–‡æ‡‰ç”¨</span>
                            <h1 className="text-xl md:text-2xl font-bold text-gray-700">èªæ³•ç©æœ¨å·¥å» </h1>
                        </div>
                        <div className="flex gap-4 text-lg font-bold text-gray-600">
                            <span>ç¬¬ {currentQIndex + 1} / {QUESTIONS.length} é¡Œ</span>
                            <span className="text-pink-500">â­ {score}</span>
                        </div>
                    </div>

                    {/* é¡Œç›®æç¤ºå€ */}
                    <div className="flex flex-col items-center mb-8">
                        <div className="text-gray-500 mb-2 font-bold">è«‹æ‹¼å‡ºåœ–ç‰‡çš„æ­£ç¢ºèªªæ³•ï¼š</div>
                        <div className="bg-white p-6 rounded-3xl shadow-md border-2 border-green-100 flex flex-col items-center w-full max-w-md">
                            <div className="text-6xl mb-2 filter drop-shadow-sm">{currentQuestion.imageHint}</div>
                            <div className="text-2xl font-bold text-gray-800">{currentQuestion.noun}</div>
                        </div>
                    </div>

                    {/* çµ„åˆå·¥ä½œå€ */}
                    <div className="flex justify-center items-end gap-1 md:gap-4 mb-8">
                        <Slot 
                            type="quantity" 
                            label="æ•¸é‡" 
                            value={slots.quantity} 
                            colorClass={{bg: "bg-pink-50", text: "text-pink-500", block: "bg-pink-500"}} 
                        />
                        <div className="text-4xl text-gray-300 pb-10 font-light">+</div>
                        <Slot 
                            type="measure" 
                            label="é‡è©" 
                            value={slots.measure} 
                            colorClass={{bg: "bg-blue-50", text: "text-blue-500", block: "bg-blue-500"}} 
                        />
                        <div className="text-4xl text-gray-300 pb-10 font-light">+</div>
                        <Slot 
                            type="noun" 
                            label="åè©" 
                            value={slots.noun} 
                            colorClass={{bg: "bg-green-50", text: "text-green-500", block: "bg-green-500"}} 
                        />
                    </div>

                    {/* å›é¥‹è¨Šæ¯ */}
                    <div className="h-10 flex justify-center items-center mb-2">
                        {feedback.msg && (
                            <div className={`
                                px-4 py-2 rounded-full font-bold text-md md:text-lg animate-bounce-short text-center
                                ${feedback.type === 'error' ? 'bg-red-100 text-red-600' : 
                                  feedback.type === 'success' ? 'bg-green-100 text-green-600' : 
                                  'bg-blue-50 text-blue-700 border border-blue-200'}
                            `}>
                                {feedback.msg}
                            </div>
                        )}
                    </div>

                    {/* æª¢æŸ¥æŒ‰éˆ• */}
                    <div className="flex justify-center mb-6">
                        <button 
                            onClick={checkAnswer}
                            className={`
                                text-white text-xl font-bold py-3 px-12 rounded-full shadow-lg transform transition active:scale-95
                                ${slots.quantity && slots.measure && slots.noun ? 'bg-indigo-500 hover:bg-indigo-600' : 'bg-gray-300 cursor-not-allowed'}
                            `}
                        >
                            {slots.quantity && slots.measure && slots.noun ? 'âœ¨ æª¢æŸ¥ç­”æ¡ˆ' : 'è«‹å…ˆæ”¾å…¥ç©æœ¨'}
                        </button>
                    </div>

                    {/* ç©æœ¨å€‰åº« */}
                    <div className="flex-1 bg-white rounded-xl shadow-inner p-4 border-t-4 border-gray-100">
                        <div className="text-center text-gray-400 mb-2 font-bold text-sm">
                            {selectedItem ? 'ğŸ‘‡ è«‹é»æ“Šä¸Šæ–¹çš„æ ¼å­' : 'ğŸ‘‡ é»æ“Šæˆ–æ‹–æ›³ä¸‹æ–¹çš„ç©æœ¨'}
                        </div>
                        <div className="flex flex-wrap justify-center gap-2">
                            {inventory.map((item) => (
                                <Block key={item.id} item={item} />
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>